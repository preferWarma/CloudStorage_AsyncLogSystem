# 查找 GoogleTest
find_package(GTest REQUIRED)

# 查找curl库
find_package(PkgConfig REQUIRED)
find_package(Threads REQUIRED)
pkg_check_modules(CURL REQUIRED libcurl)

# 包含 GoogleTest
include_directories(${GTEST_INCLUDE_DIRS})

file(GLOB_RECURSE LYF_SOURCES
    Test_LogSystem.cpp
    Test_JsonHelper.cpp
)

enable_testing() # 启用测试功能

foreach(SOURCE ${LYF_SOURCES})
    get_filename_component(TEST_NAME ${SOURCE} NAME_WE) # 获取文件名
    add_executable(${TEST_NAME} ${SOURCE}) # 添加可执行文件
    target_include_directories(${TEST_NAME} PRIVATE ${PROJECT_SOURCE_DIR}/include ${CURL_INCLUDE_DIRS}) # 添加头文件路径
    target_link_libraries(${TEST_NAME} ${GTEST_LIBRARIES} pthread ${CURL_LIBRARIES}) # 链接gtest, curl
    target_compile_options(${TEST_NAME} PRIVATE ${CURL_CFLAGS_OTHER})

    # 包含测试
    include(GoogleTest)
    gtest_discover_tests(${TEST_NAME})

    # 添加测试
    add_test(NAME ${TEST_NAME} COMMAND ${TEST_NAME})
endforeach(SOURCE ${LYF_SOURCES})

find_package(benchmark REQUIRED)
add_executable(log_benchmark log_benchmark.cpp)
target_include_directories(log_benchmark PRIVATE ${PROJECT_SOURCE_DIR}/include ${CURL_INCLUDE_DIRS})
target_link_libraries(log_benchmark PRIVATE benchmark::benchmark pthread ${CURL_LIBRARIES})
